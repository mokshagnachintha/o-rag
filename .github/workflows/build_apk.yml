name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:   # lets you trigger manually from GitHub website

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # ── 1. Checkout code ──────────────────────────────────── #
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ─────────────────────────────────── #
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ── 3. Install system dependencies ───────────────────── #
      - name: Install system packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git zip unzip openjdk-17-jdk \
            autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev libncursesw5-dev \
            libtinfo5 cmake libffi-dev libssl-dev \
            wget lld clang

      # ── 4. Install Buildozer + python-for-android ────────── #
      - name: Install Buildozer
        run: |
          pip install --upgrade pip setuptools wheel cython
          pip install buildozer python-for-android

      # ── 5. Cache Android SDK/NDK and p4a builds ──────────── #
      - name: Cache Buildozer global dir
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: buildozer-${{ runner.os }}-

      - name: Cache .buildozer project dir
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-project-${{ runner.os }}-${{ hashFiles('buildozer.spec','requirements.txt') }}
          restore-keys: buildozer-project-${{ runner.os }}-

      # Cache the GGUF model so it isn't re-downloaded on every build
      - name: Cache GGUF model
        uses: actions/cache@v4
        with:
          path: "*.gguf"
          key: gguf-model-Q5_K_M

      # ── 6. Download llama-server ARM64 binary ────────────────────── #
      - name: Download llama-server ARM64 Android binary
        run: |
          python3 - <<'EOF'
          import urllib.request, json, zipfile, os, shutil

          # Get latest llama.cpp release that has an Android ARM64 asset
          with urllib.request.urlopen(
              "https://api.github.com/repos/ggml-org/llama.cpp/releases?per_page=10"
          ) as r:
              releases = json.load(r)

          asset_url = None
          for release in releases:
              for asset in release["assets"]:
                  name = asset["name"].lower()
                  if "android" in name and "arm64" in name and name.endswith(".zip"):
                      asset_url = asset["browser_download_url"]
                      print(f"Found: {asset['name']} in {release['tag_name']}")
                      break
              if asset_url:
                  break

          if not asset_url:
              print("WARNING: No Android ARM64 llama.cpp release found — LLM will be unavailable")
          else:
              print(f"Downloading: {asset_url}")
              urllib.request.urlretrieve(asset_url, "llama_android.zip")
              with zipfile.ZipFile("llama_android.zip") as zf:
                  zf.extractall("llama_android_tmp")
              # Find llama-server binary
              found = False
              for root, dirs, files in os.walk("llama_android_tmp"):
                  for f in files:
                      if f in ("llama-server", "llama-server-android"):
                          src = os.path.join(root, f)
                          shutil.copy2(src, "llama-server-arm64")
                          os.chmod("llama-server-arm64", 0o755)
                          size_mb = os.path.getsize("llama-server-arm64") / 1_048_576
                          print(f"llama-server-arm64 ready ({size_mb:.1f} MB)")
                          found = True
                          break
                      if found:
                          break
              if not found:
                  import glob
                  files = glob.glob("llama_android_tmp/**/*", recursive=True)
                  print("Files in zip:", "\n  ".join(files[:20]))
                  print("WARNING: llama-server binary not found in release zip")
          EOF

      # ── 7. Download the GGUF model (bundled into the APK) ────────── #
      - name: Download GGUF model
        run: |
          pip install huggingface-hub
          python - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os, shutil
          filename = "Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking.i1-Q5_K_M.gguf"
          dest = os.path.join(os.getcwd(), filename)
          if os.path.isfile(dest):
              print(f"Already exists: {dest}")
          else:
              print("Downloading GGUF model (~851 MB) from Hugging Face...")
              path = hf_hub_download(
                  repo_id="mradermacher/Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking-i1-GGUF",
                  filename=filename,
                  local_dir=".",
                  local_dir_use_symlinks=False,
              )
              if os.path.abspath(path) != os.path.abspath(dest):
                  shutil.copy2(path, dest)
              print(f"Downloaded: {dest} ({os.path.getsize(dest)/1_048_576:.0f} MB)")
          EOF

      # ── 8. Build APK ─────────────────────────────────────────────── #
      - name: Build Android debug APK
        run: |
          # Accept all Android SDK licenses non-interactively
          yes | buildozer android debug 2>&1 | tee build.log

      # ── 8. Upload APK as artifact ─────────────────────────────────── #
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: OfflineRAG-debug-apk
          path: bin/*.apk
          retention-days: 30

      # ── 9. Upload build log if anything fails ─────────────── #
      - name: Upload build log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7
