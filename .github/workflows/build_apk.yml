name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:   # lets you trigger manually from GitHub website

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # ── 1. Checkout code ──────────────────────────────────── #
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ─────────────────────────────────── #
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ── 3. Set up Java 17 (required by p4a's AGP 8.x) ────────────── #
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ── 4. Install system dependencies ───────────────────── #
      - name: Install system packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git zip unzip \
            autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev libncursesw5-dev \
            libtinfo5 cmake libffi-dev libssl-dev \
            wget lld clang

      # ── 5. Install Buildozer + python-for-android ────────── #
      - name: Install Buildozer
        run: |
          pip install --upgrade pip setuptools wheel cython
          pip install buildozer python-for-android

      # ── 6. Cache Android SDK/NDK and p4a builds ──────────── #
      - name: Cache Buildozer global dir
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: buildozer-${{ runner.os }}-

      - name: Cache .buildozer project dir
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-project-${{ runner.os }}-${{ hashFiles('buildozer.spec','requirements.txt') }}
          restore-keys: buildozer-project-${{ runner.os }}-

      # ── 6. Download llama-server ARM64 binary ────────────────────── #
      - name: Download llama-server ARM64 Android binary
        run: |
          python3 - <<'EOF'
          import urllib.request, json, zipfile, os, shutil

          # Get latest llama.cpp release that has an Android ARM64 asset
          with urllib.request.urlopen(
              "https://api.github.com/repos/ggml-org/llama.cpp/releases?per_page=10"
          ) as r:
              releases = json.load(r)

          asset_url = None
          for release in releases:
              for asset in release["assets"]:
                  name = asset["name"].lower()
                  if "android" in name and "arm64" in name and name.endswith(".zip"):
                      asset_url = asset["browser_download_url"]
                      print(f"Found: {asset['name']} in {release['tag_name']}")
                      break
              if asset_url:
                  break

          if not asset_url:
              print("WARNING: No Android ARM64 llama.cpp release found — LLM will be unavailable")
          else:
              print(f"Downloading: {asset_url}")
              urllib.request.urlretrieve(asset_url, "llama_android.zip")
              with zipfile.ZipFile("llama_android.zip") as zf:
                  zf.extractall("llama_android_tmp")
              # Find llama-server binary
              found = False
              for root, dirs, files in os.walk("llama_android_tmp"):
                  for f in files:
                      if f in ("llama-server", "llama-server-android"):
                          src = os.path.join(root, f)
                          shutil.copy2(src, "llama-server-arm64")
                          os.chmod("llama-server-arm64", 0o755)
                          size_mb = os.path.getsize("llama-server-arm64") / 1_048_576
                          print(f"llama-server-arm64 ready ({size_mb:.1f} MB)")
                          found = True
                          break
                      if found:
                          break
              if not found:
                  import glob
                  files = glob.glob("llama_android_tmp/**/*", recursive=True)
                  print("Files in zip:", "\n  ".join(files[:20]))
                  print("WARNING: llama-server binary not found in release zip")
          EOF

      # ── 8. Build APK ─────────────────────────────────────────────── #
      - name: Build Android debug APK
        env:
          # Give the Gradle daemon enough heap for asset processing
          GRADLE_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=512m"
        run: |
          # Confirm Java version
          java -version
          # Delete stale Gradle dist - regenerates fresh under current JDK
          rm -rf .buildozer/android/platform/build-arm64-v8a/dists/
          # Pin Cython to a version compatible with pyjnius (kivy dep)
          pip install "cython==0.29.37" --quiet
          # Accept Android SDK licenses explicitly (avoids yes-pipe exit code issue)
          mkdir -p ~/.android && touch ~/.android/repositories.cfg
          yes 2>/dev/null | $HOME/.buildozer/android/platform/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses || true
          # Build
          buildozer android debug 2>&1 | tee build.log
          # Exit with buildozer exit code (not tee's)
          exit ${PIPESTATUS[0]}

      # ── 9. Bundle GGUF model into APK (post-process, bypass Gradle) ── #
      - name: Bundle GGUF model into APK
        run: |
          set -e

          # --- 9a. Download the Q4 model (~806 MB, smaller than Q5) ---
          pip install huggingface-hub --quiet
          python3 - <<'PYEOF'
          import os, sys
          from huggingface_hub import hf_hub_download
          path = hf_hub_download(
              repo_id  = "mradermacher/Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking-i1-GGUF",
              filename = "Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking.i1-Q4_K_M.gguf",
              local_dir= "model_tmp",
              local_dir_use_symlinks=False,
          )
          size_mb = os.path.getsize(path) // 1_048_576
          print(f"Downloaded: {path}  ({size_mb} MB)")
          PYEOF

          # --- 9b. Patch the APK: strip old signature, add model as ZIP_STORED ---
          python3 - <<'PYEOF'
          import zipfile, glob, os, shutil

          apk_path   = glob.glob("bin/*.apk")[0]
          model_path = glob.glob("model_tmp/*.gguf")[0]
          tmp_path   = apk_path + ".patching.tmp"

          print(f"Patching {apk_path}  ({os.path.getsize(apk_path)//1_048_576} MB)")
          print(f"Adding model {model_path}  ({os.path.getsize(model_path)//1_048_576} MB)")

          # Re-pack APK without META-INF (signature), then add model uncompressed
          with zipfile.ZipFile(apk_path, "r") as src, \
               zipfile.ZipFile(tmp_path, "w", compression=zipfile.ZIP_DEFLATED, allowZip64=True) as dst:

              # Copy all existing entries except the JAR signature
              for item in src.infolist():
                  if item.filename.startswith("META-INF/"):
                      continue
                  data = src.read(item.filename)
                  dst.writestr(item, data)

              # Add the GGUF as a stored (uncompressed) entry — chunked, memory-efficient
              print("Adding model entry (ZIP_STORED — no compression)…")
              info = zipfile.ZipInfo("assets/models/model.gguf")
              info.compress_type = zipfile.ZIP_STORED
              CHUNK = 4 * 1024 * 1024   # 4 MB
              written = 0
              with open(model_path, "rb") as mf, dst.open(info, "w") as zout:
                  while True:
                      chunk = mf.read(CHUNK)
                      if not chunk:
                          break
                      zout.write(chunk)
                      written += len(chunk)
                      print(f"  {written // 1_048_576} MB written…", flush=True)

          os.replace(tmp_path, apk_path)
          print(f"Done.  New APK size: {os.path.getsize(apk_path)//1_048_576} MB")
          PYEOF

          # --- 9c. Create a debug signing keystore ---
          mkdir -p ~/.android
          keytool -genkey -v \
            -keystore ~/.android/debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US" \
            -noprompt 2>/dev/null || true

          # --- 9d. Re-sign with apksigner from Android build-tools ---
          APKSIGNER=$(find $HOME/.buildozer/android/platform/android-sdk/build-tools \
            -name "apksigner" -type f 2>/dev/null | sort -V | tail -1)
          echo "apksigner: $APKSIGNER"

          APK=$(find bin -name "*.apk" | head -1)
          "$APKSIGNER" sign \
            --ks ~/.android/debug.keystore \
            --ks-pass pass:android \
            --key-pass pass:android \
            "$APK"

          echo "=== Final bundled APK ==="
          ls -lh bin/*.apk

      # ── 10. Upload APK as artifact ─────────────────────────────────── #
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: OfflineRAG-debug-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error

      # ── 10. Upload build log if anything fails ─────────────── #
      - name: Upload build log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

