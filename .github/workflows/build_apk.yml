name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:   # lets you trigger manually from GitHub website

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # ── 1. Checkout code ──────────────────────────────────── #
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ─────────────────────────────────── #
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ── 3. Install system dependencies ───────────────────── #
      - name: Install system packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git zip unzip openjdk-17-jdk \
            autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev libncursesw5-dev \
            libtinfo5 cmake libffi-dev libssl-dev \
            wget lld clang

      # ── 4. Install Buildozer + python-for-android ────────── #
      - name: Install Buildozer
        run: |
          pip install --upgrade pip setuptools wheel cython
          pip install buildozer python-for-android

      # ── 5. Cache Android SDK/NDK and p4a builds ──────────── #
      - name: Cache Buildozer global dir
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: buildozer-${{ runner.os }}-

      - name: Cache .buildozer project dir
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-project-${{ runner.os }}-${{ hashFiles('buildozer.spec','requirements.txt') }}
          restore-keys: buildozer-project-${{ runner.os }}-

      # Cache the GGUF model so it isn't re-downloaded on every build
      - name: Cache GGUF model
        uses: actions/cache@v4
        with:
          path: "*.gguf"
          key: gguf-model-Q5_K_M

      # ── 6. Download the GGUF model (bundled into the APK) ──────────── #
      - name: Download GGUF model
        run: |
          pip install huggingface-hub
          python - <<'EOF'
          from huggingface_hub import hf_hub_download
          import os, shutil
          filename = "Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking.i1-Q5_K_M.gguf"
          dest = os.path.join(os.getcwd(), filename)
          if os.path.isfile(dest):
              print(f"Already exists: {dest}")
          else:
              print("Downloading GGUF model (~851 MB) from Hugging Face...")
              path = hf_hub_download(
                  repo_id="mradermacher/Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking-i1-GGUF",
                  filename=filename,
                  local_dir=".",
                  local_dir_use_symlinks=False,
              )
              if os.path.abspath(path) != os.path.abspath(dest):
                  shutil.copy2(path, dest)
              print(f"Downloaded: {dest} ({os.path.getsize(dest)/1_048_576:.0f} MB)")
          EOF

      # ── 7. Build APK ─────────────────────────────────────────────── #
      - name: Build Android debug APK
        run: |
          # Accept all Android SDK licenses non-interactively
          yes | buildozer android debug 2>&1 | tee build.log

      # ── 8. Upload APK as artifact ─────────────────────────────────── #
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: OfflineRAG-debug-apk
          path: bin/*.apk
          retention-days: 30

      # ── 9. Upload build log if anything fails ─────────────── #
      - name: Upload build log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7
