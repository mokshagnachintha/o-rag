name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-apk:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      # ── 1. Checkout ───────────────────────────────────────── #
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Set up Python ─────────────────────────────────── #
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ── 3. Set up Java 17 (required by p4a's AGP 8.x) ────────────── #
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # ── 4. System packages ────────────────────────────────── #
      - name: Install system packages
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            git zip unzip ninja-build \
            autoconf libtool pkg-config \
            zlib1g-dev libncurses5-dev libncursesw5-dev \
            libtinfo5 cmake libffi-dev libssl-dev \
            wget lld clang

      # ── 5. Install Buildozer + python-for-android ────────── #
      - name: Install Buildozer
        run: |
          pip install --upgrade pip setuptools wheel cython
          pip install buildozer python-for-android

      # ── 6. Cache Android SDK/NDK and p4a builds ──────────── #
      - name: Cache Buildozer global dir
        uses: actions/cache@v4
        with:
          path: ~/.buildozer
          key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
          restore-keys: buildozer-${{ runner.os }}-

      - name: Cache .buildozer project dir
        uses: actions/cache@v4
        with:
          path: .buildozer
          key: buildozer-project-${{ runner.os }}-${{ hashFiles('buildozer.spec','requirements.txt') }}
          restore-keys: buildozer-project-${{ runner.os }}-

      # ── 6. Clone llama.cpp source (compiled after NDK is ready) ─────── #
      - name: Clone llama.cpp source
        run: |
          git clone --depth 1 https://github.com/ggml-org/llama.cpp.git llama_cpp_src
          echo "llama.cpp cloned: $(ls llama_cpp_src)"

      # ── 8. Build APK ─────────────────────────────────────────────── #
      - name: Build Android debug APK
        env:
          # Give the Gradle daemon enough heap for asset processing
          GRADLE_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=512m"
        run: |
          # Confirm Java version
          java -version
          # Delete stale Gradle dist - regenerates fresh under current JDK
          rm -rf .buildozer/android/platform/build-arm64-v8a/dists/
          # Pin Cython to a version compatible with pyjnius (kivy dep)
          pip install "cython==0.29.37" --quiet
          # Pre-write all Android SDK license hashes so sdkmanager never prompts
          mkdir -p ~/.android && touch ~/.android/repositories.cfg
          mkdir -p $HOME/.buildozer/android/platform/android-sdk/licenses
          printf "24333f8a63b6825ea9c5514f83c2829b004d1fee\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e\n" \
            > $HOME/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
          printf "84831b9409646a918e30573bab4c9c91346d8abd\nd975f751698a77b662f1254ddbeed3901e976f5a\n" \
            > $HOME/.buildozer/android/platform/android-sdk/licenses/android-sdk-preview-license
          printf "33b6a2b64607f11b759f320ef9dff4ae5c47d97a\n" \
            > $HOME/.buildozer/android/platform/android-sdk/licenses/google-gdk-license
          printf "d975f751698a77b662f1254ddbeed3901e976f5a\n" \
            > $HOME/.buildozer/android/platform/android-sdk/licenses/intel-android-extra-license
          printf "859f317696f67ef3d7f30a50a5560e7834b43903\n" \
            > $HOME/.buildozer/android/platform/android-sdk/licenses/android-sdk-arm-dbt-license
          # Build — pipe yes so any remaining interactive prompts are answered
          yes 2>/dev/null | buildozer android debug 2>&1 | tee build.log
          # PIPESTATUS: 0=yes, 1=buildozer, 2=tee
          exit ${PIPESTATUS[1]}

      # ── 9. Compile llama-server + bundle model + patch APK ── #
      - name: Bundle server binary and GGUF model into APK
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          # ── 9a. Compile llama-server for Android ARM64 ───────────────
          echo "=== Step 9a: Compiling llama-server for Android ARM64 ==="

          NDK_HOME=$(find $HOME/.buildozer/android/platform -maxdepth 1 \
            -name "android-ndk-*" -type d | head -1)
          TOOLCHAIN="$NDK_HOME/build/cmake/android.toolchain.cmake"

          echo "NDK: $NDK_HOME"
          echo "Toolchain: $TOOLCHAIN"

          if [ ! -f "$TOOLCHAIN" ]; then
            echo "FATAL: Android NDK toolchain not found!"
            find $HOME/.buildozer/android/platform -name "android.toolchain.cmake" 2>/dev/null
            exit 1
          fi

          cmake -S llama_cpp_src -B llama_build \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-26 \
            -DCMAKE_BUILD_TYPE=Release \
            -DGGML_NATIVE=OFF \
            -DBUILD_SHARED_LIBS=OFF \
            -DLLAMA_CURL=OFF \
            -DLLAMA_BUILD_TESTS=OFF \
            -DLLAMA_BUILD_EXAMPLES=ON \
            -DLLAMA_SERVER_VERBOSE=OFF
          echo "cmake configure done (exit $?)"

          cmake --build llama_build --target llama-server -j$(nproc)
          echo "cmake build done (exit $?)"

          BIN=$(find llama_build -name "llama-server" -type f 2>/dev/null | head -1)
          echo "Binary found at: $BIN"
          if [ -z "$BIN" ]; then
            echo "ERROR: llama-server not found. All built files:"
            find llama_build -type f 2>/dev/null | head -40
            exit 1
          fi
          cp "$BIN" llama-server-arm64
          chmod 755 llama-server-arm64
          echo "SUCCESS: $(du -sh llama-server-arm64)"

          # ── 9b. Download GGUF model ───────────────────────────────────
          echo "=== Step 9b: Downloading Gemma GGUF model ==="
          pip install huggingface-hub --quiet
          python3 - <<'PYEOF'
          import os
          from huggingface_hub import hf_hub_download
          path = hf_hub_download(
              repo_id="mradermacher/Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking-i1-GGUF",
              filename="Gemma-3-1B-it-GLM-4.7-Flash-Heretic-Uncensored-Thinking.i1-Q4_K_M.gguf",
              local_dir="model_tmp",
              local_dir_use_symlinks=False,
          )
          print(f"Model: {path} ({os.path.getsize(path)//1_048_576} MB)")
          PYEOF

          # ── 9c. Patch APK — inject model + binary in one pass ────────
          echo "=== Step 9c: Patching APK ==="
          python3 - <<'PYEOF'
          import zipfile, glob, os

          apk   = glob.glob("bin/*.apk")[0]
          model = glob.glob("model_tmp/*.gguf")[0]
          srv   = "llama-server-arm64"
          tmp   = apk + ".tmp"
          CHUNK = 4 * 1024 * 1024

          print(f"APK:    {apk}  ({os.path.getsize(apk)//1_048_576} MB)")
          print(f"Model:  {model}  ({os.path.getsize(model)//1_048_576} MB)")
          print(f"Binary: {srv}  ({os.path.getsize(srv)//1024} KB)")

          with zipfile.ZipFile(apk, "r") as src, \
               zipfile.ZipFile(tmp, "w", compression=zipfile.ZIP_DEFLATED, allowZip64=True) as dst:

              for item in src.infolist():
                  if item.filename.startswith("META-INF/"):
                      continue
                  dst.writestr(item, src.read(item.filename))

              print("Adding model (ZIP_STORED, uncompressed)...")
              mi = zipfile.ZipInfo("assets/models/model.gguf")
              mi.compress_type = zipfile.ZIP_STORED
              written = 0
              with open(model, "rb") as mf, dst.open(mi, "w") as zo:
                  while chunk := mf.read(CHUNK):
                      zo.write(chunk)
                      written += len(chunk)
                      if written % (100*1024*1024) == 0:
                          print(f"  {written//1_048_576} MB...", flush=True)

              print("Adding llama-server-arm64 (ZIP_STORED)...")
              bi = zipfile.ZipInfo("llama-server-arm64")
              bi.compress_type = zipfile.ZIP_STORED
              bi.external_attr = 0o755 << 16
              with open(srv, "rb") as bf, dst.open(bi, "w") as zo:
                  while chunk := bf.read(CHUNK):
                      zo.write(chunk)

          os.replace(tmp, apk)
          print(f"Done. Final APK: {os.path.getsize(apk)//1_048_576} MB")
          PYEOF

          # ── 9d. Sign APK ──────────────────────────────────────────────
          echo "=== Step 9d: Signing APK ==="
          mkdir -p ~/.android
          keytool -genkey -v \
            -keystore ~/.android/debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass android -keypass android \
            -dname "CN=Android Debug,O=Android,C=US" \
            -noprompt 2>/dev/null || true

          APKSIGNER=$(find $HOME/.buildozer/android/platform/android-sdk/build-tools \
            -name "apksigner" -type f 2>/dev/null | sort -V | tail -1)
          APK=$(find bin -name "*.apk" | head -1)
          "$APKSIGNER" sign \
            --ks ~/.android/debug.keystore \
            --ks-pass pass:android --key-pass pass:android \
            "$APK"

          echo "=== FINAL APK ==="
          ls -lh bin/*.apk

      # ── 10. Upload APK as artifact ─────────────────────────────────── #
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: OfflineRAG-debug-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error

      # ── 10. Upload build log if anything fails ─────────────── #
      - name: Upload build log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

